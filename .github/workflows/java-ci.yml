name: Java CI - Pruebas Individuales y Resumen Global

on:
  push:
    branches: [ main, master ]

jobs:
  test-and-generate-reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar el repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configurar Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Obtener información del commit
        id: commit_info
        run: |
          echo "author_name=${{ github.event.head_commit.author.name }}" >> $GITHUB_OUTPUT
          echo "author_email=${{ github.event.head_commit.author.email }}" >> $GITHUB_OUTPUT
          echo "commit_message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          echo "commit_count=$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT

      - name: Ejecutar Tests y Generar Reportes Individuales
        id: test_runner
        run: |
          declare -A TESTS=(
            ["rectangulo"]="TestRectangle|Rectángulo (Área y Perímetro)"
            ["ps1_3"]="TestConversorMoneda|PS 1.3 - Casa de Cambio"
            ["calificacion"]="TestCalificacion|Calificación (Aprobado/Reprobado)"
            ["numero"]="TestNumero|PS 2.6 - Par, Impar o Nulo"
            ["ps2_18"]="TestCostoLlamada|PS 2.18 - Costo Llamada Telefónica"
            ["serie"]="TestCalculadorSerie|PS 3.3 - Cálculo de Serie"
            ["perfectos"]="TestBuscadorPerfectos|PS 3.19 - Números Perfectos"
            ["ps3_33"]="TestMCD|PS 3.33 - Máximo Común Divisor"
            ["ps3_34"]="TestEcuacionPares|PS 3.34 - Ecuación (m, n)"
            ["ps3_35"]="TestEcuacionTrio|PS 3.35 - Ecuación (X, Y, Z)"
            ["ps3_36"]="TestAnalizadorGranja|PS 3.36 - La Granja"
            ["insercion"]="TestInsercionDirecta|Ej 4.11 - Inserción Directa"
            ["temperaturas"]="TestAnalizadorTemperaturas|PS 4.19 - Temperaturas 3D"
            ["ps4_8"]="TestBusquedaSecuencialOrdenada|PS 4.8 - Búsqueda Ordenada"
            ["ps4_24"]="TestAnalizadorCalificaciones|PS 4.24 - Calificaciones Alumnos"
            ["ps5_3"]="TestInmobiliaria|PS 5.3 - Inmobiliaria"
          )

          FAILED_ANY=0
          SUMMARY_FILE="resumen_global.html"
          echo "<html><head><title>Resumen de Pruebas</title></head><body>" > $SUMMARY_FILE
          echo "<h1>Resumen de Pruebas</h1><ul>" >> $SUMMARY_FILE

          for key in "${!TESTS[@]}"; do
            CLASS_NAME=$(echo ${TESTS[$key]} | cut -d'|' -f1)
            EXERCISE_NAME=$(echo ${TESTS[$key]} | cut -d'|' -f2)
            OUTPUT_FILE="${key}_output.txt"
            RESULT_FILE="${key}_results.html"

            # CORRECCIÓN: usar ":" en classpath
            java -jar lib/junit-platform-console-standalone-1.9.3.jar -cp "src:tests" --select-class "$CLASS_NAME" > "$OUTPUT_FILE" 2>&1
            EXIT_CODE=$?

            TOTAL=$(grep 'tests found' "$OUTPUT_FILE" | awk '{print $2}')
            PASSED=$(grep 'tests successful' "$OUTPUT_FILE" | awk '{print $2}')
            STATUS="failed"
            if [ $EXIT_CODE -eq 0 ]; then STATUS="success"; fi

            # Generar reporte HTML individual
            cp template_reporte.html "$RESULT_FILE"
            sed -i "s|{{EJERCICIO_NOMBRE}}|$EXERCISE_NAME|g" "$RESULT_FILE"
            sed -i "s|{{STATUS}}|$STATUS|g" "$RESULT_FILE"
            sed -i "s|{{TESTS_PASSED}}|${PASSED:-0}|g" "$RESULT_FILE"
            sed -i "s|{{TESTS_TOTAL}}|${TOTAL:-0}|g" "$RESULT_FILE"
            sed -i "s|{{AUTHOR}}|${{ steps.commit_info.outputs.author_name }}|g" "$RESULT_FILE"
            sed -i "s|{{EMAIL}}|${{ steps.commit_info.outputs.author_email }}|g" "$RESULT_FILE"
            sed -i "s|{{TIMESTAMP}}|${{ steps.commit_info.outputs.timestamp }}|g" "$RESULT_FILE"
            sed -i "s|{{COMMIT_MESSAGE}}|${{ steps.commit_info.outputs.commit_message }}|g" "$RESULT_FILE"
            sed -i "s|{{COMMIT_COUNT}}|${{ steps.commit_info.outputs.commit_count }}|g" "$RESULT_FILE"

            # Agregar al resumen global
            echo "<li><b>$EXERCISE_NAME:</b> $STATUS - Pasados: ${PASSED:-0}/${TOTAL:-0} - <a href='./$RESULT_FILE'>Ver detalle</a></li>" >> $SUMMARY_FILE

            if [ $EXIT_CODE -ne 0 ]; then
              FAILED_ANY=1
            fi
          done

          echo "</ul></body></html>" >> $SUMMARY_FILE

          if [ $FAILED_ANY -ne 0 ]; then
            echo "Al menos un test falló"
            exit 1
          fi

      - name: Subir Reportes y Resumen Global
        uses: actions/upload-artifact@v4
        with:
          name: reportes-de-pruebas-${{ github.run_number }}
          path: |
            *_results.html
            *_output.txt
            resumen_global.html
          retention-days: 7
