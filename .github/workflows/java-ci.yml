name: Java CI - JUnit + Cloudflare Pages

on:
  push:
    branches: [ main, master ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configurar Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Verificar archivos necesarios
      run: |
        echo "Buscando JAR..."
        ls -R lib
        if [ ! -f "lib/junit-platform-console-standalone-1.9.3.jar" ]; then
          echo "âŒ No existe lib/junit-platform-console-standalone-1.9.3.jar"
          exit 1
        fi

    - name: Compilar cÃ³digo fuente
      run: |
        mkdir -p bin
        javac -d bin src/*.java
        echo "âœ… CÃ³digo Java compilado"

    - name: Compilar tests
      run: |
        mkdir -p testbin
        javac -cp "lib/junit-platform-console-standalone-1.9.3.jar:bin" -d testbin test/*.java
        echo "âœ… Tests compilados"

    - name: Ejecutar JUnit tests
      id: run_tests
      continue-on-error: true
      run: |
        echo "ðŸ§ª Ejecutando tests..."
        java -jar lib/junit-platform-console-standalone-1.9.3.jar \
        -cp "bin:testbin" \
        --scan-class-path > test_output.txt 2>&1

        EXIT=$?

        if grep -q "FAILURE" test_output.txt || [ $EXIT -ne 0 ]; then
          echo "status=failed" >> $GITHUB_OUTPUT
        else
          echo "status=success" >> $GITHUB_OUTPUT
        fi

        echo "test_exit_code=$EXIT" >> $GITHUB_OUTPUT
        echo "âœ… Resultado procesado"

    - name: Preparar reporte HTML
      run: |
        cp template_reporte.html index.html

        STATUS="${{ steps.run_tests.outputs.status }}"
        AUTHOR="$(git log -1 --pretty=format:'%an')"
        TIMESTAMP="$(git log -1 --pretty=format:'%ad')"
        COMMIT_MESSAGE="$(git log -1 --pretty=format:'%s')"
        COMMIT_COUNT=$(git rev-list --count HEAD)

        sed -i "s/{{STATUS}}/$STATUS/" index.html
        sed -i "s/{{AUTHOR}}/$AUTHOR/" index.html
        sed -i "s/{{TIMESTAMP}}/$TIMESTAMP/" index.html
        sed -i "s/{{COMMIT_MESSAGE}}/$COMMIT_MESSAGE/" index.html
        sed -i "s/{{COMMIT_COUNT}}/$COMMIT_COUNT/" index.html

        # Insertar logs de tests
        OUTPUT=$(sed 's/"/\\"/g' test_output.txt | sed ':a;N;$!ba;s/\n/<br>/g')
        sed -i "s|{{TEST_OUTPUT}}|$OUTPUT|" index.html

        echo "âœ… Reporte HTML generado"

    - name: Subir artifact si falla
      if: steps.run_tests.outputs.status == 'failed'
      uses: actions/upload-artifact@v4
      with:
        name: test-output-${{ github.run_number }}
        path: test_output.txt

    - name: Deploy a Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        directory: ./
