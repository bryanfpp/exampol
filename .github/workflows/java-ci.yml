name: Ejecutar Tests y Publicar Reporte

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: pip install pytest

      - name: Ejecutar tests
        id: run_tests
        continue-on-error: true
        run: |
          set +e
          python -m pytest tests/test_person.py -v --tb=no > test_output.txt 2>&1
          EXIT=$?
          set -e

          PASSED=$(grep -c "PASSED" test_output.txt || echo "0")
          FAILED=$(grep -c "FAILED" test_output.txt || echo "0")
          TOTAL=$((PASSED + FAILED))

          PASSED_LIST=$(grep "PASSED" test_output.txt | sed 's/::/ - /')
          FAILED_LIST=$(grep "FAILED" test_output.txt | sed 's/::/ - /')

          echo "status=$([ $EXIT -eq 0 ] && echo success || echo failed)" >> $GITHUB_OUTPUT
          echo "tests_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "tests_failed=$FAILED" >> $GITHUB_OUTPUT
          echo "tests_total=$TOTAL" >> $GITHUB_OUTPUT

          echo "passed_list<<EOF" >> $GITHUB_OUTPUT
          echo "$PASSED_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "failed_list<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Obtener datos del commit
        id: commit_info
        run: |
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "email=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "count=$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT
          echo "time=$(date)" >> $GITHUB_OUTPUT

      - name: Generar index.html desde template
        run: |
          cp template_reporte.html index.html

          envsubst '\
          $STATUS \
          $AUTHOR \
          $EMAIL \
          $TIMESTAMP \
          $COMMIT_COUNT \
          $COMMIT_MESSAGE \
          $TESTS_PASSED \
          $TESTS_FAILED \
          $TESTS_TOTAL \
          $PASSED_LIST \
          $FAILED_LIST' < index.html > index.tmp.html

          mv index.tmp.html index.html
        env:
          STATUS: ${{ steps.run_tests.outputs.status }}
          AUTHOR: ${{ steps.commit_info.outputs.author }}
          EMAIL: ${{ steps.commit_info.outputs.email }}
          TIMESTAMP: ${{ steps.commit_info.outputs.time }}
          COMMIT_COUNT: ${{ steps.commit_info.outputs.count }}
          COMMIT_MESSAGE: ${{ steps.commit_info.outputs.message }}
          TESTS_PASSED: ${{ steps.run_tests.outputs.tests_passed }}
          TESTS_FAILED: ${{ steps.run_tests.outputs.tests_failed }}
          TESTS_TOTAL: ${{ steps.run_tests.outputs.tests_total }}
          PASSED_LIST: ${{ steps.run_tests.outputs.passed_list }}
          FAILED_LIST: ${{ steps.run_tests.outputs.failed_list }}

      - name: Subir artifact para Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
