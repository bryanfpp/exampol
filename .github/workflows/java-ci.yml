name: Ejecutar Tests y Publicar Reporte

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Instalar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar dependencias
      run: pip install pytest

    - name: Ejecutar tests
      id: run_tests
      continue-on-error: true
      run: |
        set +e
        python -m pytest tests/test_person.py -v --tb=no > test_output.txt 2>&1
        EXIT=$?
        set -e

        PASSED=$(grep -c "PASSED" test_output.txt || echo "0")
        FAILED=$(grep -c "FAILED" test_output.txt || echo "0")
        TOTAL=$((PASSED + FAILED))

        PASSED_LIST=$(grep "PASSED" test_output.txt | sed 's/::/ - /' | sed 's/^/<li class="pass">/' | sed 's/$/<\/li>/')
        FAILED_LIST=$(grep "FAILED" test_output.txt | sed 's/::/ - /' | sed 's/^/<li class="fail">/' | sed 's/$/<\/li>/')

        STATUS=$([ $EXIT -eq 0 ] && echo success || echo failed)
        STATUS_TEXT=$([ $EXIT -eq 0 ] && echo "✅ TODOS LOS TESTS PASARON" || echo "❌ HAY TESTS FALLIDOS")

        # Exportar variables para envsubst
        export STATUS
        export STATUS_TEXT
        export STATUS_CLASS=$STATUS
        export PASSED_LIST
        export FAILED_LIST
        export TESTS_PASSED=$PASSED
        export TESTS_FAILED=$FAILED
        export TESTS_TOTAL=$TOTAL

    - name: Obtener datos del commit
      id: commit_info
      run: |
        export AUTHOR="$(git log -1 --pretty=format:'%an')"
        export EMAIL="$(git log -1 --pretty=format:'%ae')"
        export COMMIT_MESSAGE="$(git log -1 --pretty=format:'%s')"
        export COMMIT_COUNT=$(git rev-list --count HEAD)
        export TIMESTAMP="$(date)"

    - name: Generar index.html desde template
      run: |
        envsubst < template_reporte.html > index.html

    - name: Publicar en GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        # Ignora el template
        exclude_assets: template_reporte.html
