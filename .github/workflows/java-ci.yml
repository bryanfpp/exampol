name: Test y Deploy OOP Exercise Java

on:
  push:
    branches: [ master, main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Compilar c√≥digo fuente
        run: |
          mkdir -p bin
          javac -d bin src/*.java

      - name: Compilar tests
        run: |
          mkdir -p testbin
          if ls tests/*.java >/dev/null 2>&1; then
            javac -cp "lib/junit-platform-console-standalone-1.9.3.jar:bin" -d testbin tests/*.java
          else
            echo "‚ö†Ô∏è No hay archivos de test en tests/"
          fi

      - name: Informaci√≥n del commit
        id: commit_info
        run: |
          AUTHOR_NAME="${{ github.event.head_commit.author.name }}"
          AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_COUNT=$(git rev-list --count HEAD)

          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Ejecutar Tests Java
        id: run_tests
        continue-on-error: true
        run: |
          set +e

          echo "üß™ Ejecutando JUnit..."
          java -jar lib/junit-platform-console-standalone-1.9.3.jar \
            --class-path "bin:testbin" \
            --scan-class-path > test_output.txt 2>&1

          TEST_EXIT_CODE=$?

          # Extraer resumen tipo:
          # "Test run finished after ... 4 tests found, 3 tests started..."
          TOTAL=$(grep -oP "(?<=tests found: )\d+" test_output.txt | head -1)
          PASSED=$(grep -oP "(?<=tests successful: )\d+" test_output.txt | head -1)
          FAILED=$(grep -oP "(?<=tests failed: )\d+" test_output.txt | head -1)

          TOTAL=${TOTAL:-0}
          PASSED=${PASSED:-0}
          FAILED=${FAILED:-0}

          echo "tests_total=$TOTAL" >> $GITHUB_OUTPUT
          echo "tests_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "tests_failed=$FAILED" >> $GITHUB_OUTPUT
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

          set -e

      - name: Generar reporte de errores (si fall√≥)
        if: steps.run_tests.outputs.status == 'failed'
        run: |
          echo "üìù Generando reporte..."

          cat > error_report.txt << EOF
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          ‚ùå REPORTE DE ERRORES - TESTS FALLIDOS
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

          Autor: ${{ steps.commit_info.outputs.author_name }}
          Email: ${{ steps.commit_info.outputs.author_email }}
          Fecha: ${{ steps.commit_info.outputs.timestamp }}
          Commit: "${{ steps.commit_info.outputs.commit_message }}"
          Intento #${{ steps.commit_info.outputs.commit_count }}

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          üìä RESULTADOS
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Tests totales: ${{ steps.run_tests.outputs.tests_total }}
          Pasados: ‚úÖ ${{ steps.run_tests.outputs.tests_passed }}
          Fallidos: ‚ùå ${{ steps.run_tests.outputs.tests_failed }}

          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          üîç DETALLES DE SALIDA DEL TEST
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

          EOF

          cat test_output.txt >> error_report.txt

      - name: Generar index.html final
        run: |
          cp template_reporte.html index.html

          STATUS="${{ steps.run_tests.outputs.status }}"
          AUTHOR="${{ steps.commit_info.outputs.author_name }}"
          EMAIL="${{ steps.commit_info.outputs.author_email }}"
          DATE="${{ steps.commit_info.outputs.timestamp }}"
          MESSAGE="${{ steps.commit_info.outputs.commit_message }}"
          PASSED="${{ steps.run_tests.outputs.tests_passed }}"
          TOTAL="${{ steps.run_tests.outputs.tests_total }}"

          # Quitar c√≥digos de color ANSI del log
          CLEAN_OUTPUT=$(sed 's/\x1B\[[0-9;]*[A-Za-z]//g' test_output.txt)

          # Cambiar saltos de l√≠nea por <br>
          OUTPUT=$(printf "%s" "$CLEAN_OUTPUT" | sed ':a;N;$!ba;s/\n/<br>/g')

          perl -pi -e "s/\{\{STATUS\}\}/$STATUS/g" index.html
          perl -pi -e "s/\{\{AUTHOR\}\}/$AUTHOR/g" index.html
          perl -pi -e "s/\{\{EMAIL\}\}/$EMAIL/g" index.html
          perl -pi -e "s/\{\{DATE\}\}/$DATE/g" index.html
          perl -pi -e "s/\{\{MESSAGE\}\}/$MESSAGE/g" index.html
          perl -pi -e "s/\{\{TESTS_PASSED\}\}/$PASSED/g" index.html
          perl -pi -e "s/\{\{TESTS_TOTAL\}\}/$TOTAL/g" index.html
          perl -pi -e "s/\{\{TEST_OUTPUT\}\}/$OUTPUT/g" index.html


      - name: Deploy a Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: exampol
          directory: ./    

      - name: Subir reporte de error (si fall√≥)
        if: steps.run_tests.outputs.status == 'failed'
        uses: actions/upload-artifact@v4
        with:
          name: error-report-${{ github.run_number }}
          path: error_report.txt

      - name: Mensaje final
        run: |
          if [ "${{ steps.run_tests.outputs.status }}" == "success" ]; then
            echo "üéâ Tests correctos. P√°gina actualizada."
          else
            echo "‚ùå Tests fallaron. P√°gina publicada con reporte."
          fi
