name: Ejecutar Tests y Publicar Reporte

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar dependencias
      run: pip install pytest

    - name: Ejecutar tests
      id: run_tests
      continue-on-error: true
      run: |
        python -m pytest tests/test_person.py -v --tb=no > test_output.txt 2>&1 || true
        PASSED=$(grep -c "PASSED" test_output.txt || echo "0")
        FAILED=$(grep -c "FAILED" test_output.txt || echo "0")
        TOTAL=$((PASSED + FAILED))
        PASSED_LIST=$(grep "PASSED" test_output.txt | sed 's/::/ - /' | sed 's/^/<li class="pass">/' | sed 's/$/<\/li>/')
        FAILED_LIST=$(grep "FAILED" test_output.txt | sed 's/::/ - /' | sed 's/^/<li class="fail">/' | sed 's/$/<\/li>/')
        STATUS=$([ $FAILED -eq 0 ] && echo success || echo failed)
        STATUS_TEXT=$([ $FAILED -eq 0 ] && echo '✅ TODOS LOS TESTS PASARON' || echo '❌ HAY TESTS FALLIDOS')
        echo "PASSED=$PASSED" >> $GITHUB_ENV
        echo "FAILED=$FAILED" >> $GITHUB_ENV
        echo "TOTAL=$TOTAL" >> $GITHUB_ENV
        echo "PASSED_LIST=$PASSED_LIST" >> $GITHUB_ENV
        echo "FAILED_LIST=$FAILED_LIST" >> $GITHUB_ENV
        echo "STATUS=$STATUS" >> $GITHUB_ENV
        echo "STATUS_TEXT=$STATUS_TEXT" >> $GITHUB_ENV

    - name: Obtener info del commit
      run: |
        echo "AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
        echo "EMAIL=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_ENV
        echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV
        echo "COMMIT_COUNT=$(git rev-list --count HEAD)" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date)" >> $GITHUB_ENV

    - name: Generar HTML final
      run: |
        envsubst < template.html > index.html

    - name: Subir artifact para Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Deploy a GitHub Pages
      uses: actions/deploy-pages@v4
