name: Test y Deploy OOP Exercise Java

on:
  push:
    branches: [ master, main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Ejecutar tests y generar summary
        run: |
          chmod +x scripts/run_tests_summary.sh
          ./scripts/run_tests_summary.sh

      - name: Generar reporte.html final
        run: |
          SUMMARY=$(cat reports/test_summary.html)
          cp template_reporte.html reporte.html
          perl -CS -pi -e "s/\{\{TEST_CLASS_SUMMARY\}\}/$SUMMARY/g" reporte.html    

      - name: Compilar c√≥digo fuente
        run: |
          mkdir -p bin
          javac -d bin src/*.java

      - name: Compilar tests
        run: |
          mkdir -p testbin
          if ls tests/*.java >/dev/null 2>&1; then
            javac -cp "lib/junit-platform-console-standalone-1.9.3.jar:bin" -d testbin tests/*.java
          else
            echo "‚ö†Ô∏è No hay archivos de test en tests/"
          fi

      - name: Informaci√≥n del commit
        id: commit_info
        run: |
          AUTHOR_NAME="${{ github.event.head_commit.author.name }}"
          AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_COUNT=$(git rev-list --count HEAD)

          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Ejecutar Tests Java
        id: run_tests
        continue-on-error: true
        run: |
          set +e

          java -jar lib/junit-platform-console-standalone-1.9.3.jar \
            --class-path "bin:testbin" \
            --scan-class-path > test_output.txt 2>&1

          TEST_EXIT_CODE=$?

          TOTAL=$(grep -oP "\[\s*\K\d+(?=\s+tests found)" test_output.txt | head -1)
          PASSED=$(grep -oP "\[\s*\K\d+(?=\s+tests successful)" test_output.txt | head -1)
          FAILED=$(grep -oP "\[\s*\K\d+(?=\s+tests failed)" test_output.txt | head -1)

          TOTAL=${TOTAL:-0}
          PASSED=${PASSED:-0}
          FAILED=${FAILED:-0}

          echo "tests_total=$TOTAL" >> $GITHUB_OUTPUT
          echo "tests_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "tests_failed=$FAILED" >> $GITHUB_OUTPUT
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          set -e

      - name: Generar reporte.html final
        run: |
        
          # YA NO tocamos index.html, solo generamos reporte.html
          cp template_reporte.html reporte.html

          STATUS="${{ steps.run_tests.outputs.status }}"
          AUTHOR="${{ steps.commit_info.outputs.author_name }}"
          EMAIL="${{ steps.commit_info.outputs.author_email }}"
          DATE="${{ steps.commit_info.outputs.timestamp }}"
          MESSAGE="${{ steps.commit_info.outputs.commit_message }}"
          COMMIT="${{ steps.commit_info.outputs.commit_count }}"
          PASSED="${{ steps.run_tests.outputs.tests_passed }}"
          TOTAL="${{ steps.run_tests.outputs.tests_total }}"
          FAILED=$((TOTAL - PASSED))

          CLEAN_OUTPUT=$(sed 's/\x1B\[[0-9;]*[A-Za-z]//g' test_output.txt)
          OUTPUT=$(printf "%s" "$CLEAN_OUTPUT" | sed ':a;N;$!ba;s/\n/<br>/g')
          SAFE_OUTPUT=$(printf "%s" "$OUTPUT" | sed 's/[&/]/\\&/g')

          perl -CS -pi -e "s/\{\{STATUS\}\}/$STATUS/g" reporte.html
          perl -CS -pi -e "s/\{\{AUTHOR\}\}/$AUTHOR/g" reporte.html
          perl -CS -pi -e "s/\{\{EMAIL\}\}/$EMAIL/g" reporte.html
          perl -CS -pi -e "s/\{\{DATE\}\}/$DATE/g" reporte.html
          perl -CS -pi -e "s/\{\{MESSAGE\}\}/$MESSAGE/g" reporte.html
          perl -CS -pi -e "s/\{\{COMMIT\}\}/$COMMIT/g" reporte.html
          perl -CS -pi -e "s/\{\{TESTS_PASSED\}\}/$PASSED/g" reporte.html
          perl -CS -pi -e "s/\{\{TESTS_TOTAL\}\}/$TOTAL/g" reporte.html
          perl -CS -pi -e "s/\{\{TESTS_FAILED\}\}/$FAILED/g" reporte.html
          perl -CS -pi -e "s/\{\{TEST_OUTPUT\}\}/$SAFE_OUTPUT/g" reporte.html
          perl -CS -pi -e "s/\{\{TEST_CLASS_SUMMARY\}\}/$SUMMARY/g" reporte.html    




      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: exampol
          directory: ./   # Esto asegura que se publique index.html + reporte.html

      - name: Subir reporte de error (si fall√≥)
        if: steps.run_tests.outputs.status == 'failed'
        uses: actions/upload-artifact@v4
        with:
          name: error-report-${{ github.run_number }}
          path: error_report.txt

      - name: Mensaje final
        run: |
          if [ "${{ steps.run_tests.outputs.status }}" == "success" ]; then
            echo "üéâ Tests correctos. P√°gina actualizada."
          else
            echo "‚ùå Tests fallaron. P√°gina publicada con reporte."
          fi
