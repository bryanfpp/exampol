name: Ejecutar Tests y Publicar Reporte

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Instalar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar dependencias
      run: pip install pytest

    - name: Ejecutar tests
      id: run_tests
      continue-on-error: true
      run: |
        set +e
        python -m pytest tests/test_person.py -v --tb=no > test_output.txt 2>&1
        EXIT=$?
        set -e

        PASSED=$(grep -c "PASSED" test_output.txt || echo "0")
        FAILED=$(grep -c "FAILED" test_output.txt || echo "0")
        TOTAL=$((PASSED + FAILED))

        PASSED_LIST=$(grep "PASSED" test_output.txt | sed 's/::/ - /')
        FAILED_LIST=$(grep "FAILED" test_output.txt | sed 's/::/ - /')

        echo "status=$([ $EXIT -eq 0 ] && echo success || echo failed)" >> $GITHUB_OUTPUT
        echo "tests_passed=$PASSED" >> $GITHUB_OUTPUT
        echo "tests_failed=$FAILED" >> $GITHUB_OUTPUT
        echo "tests_total=$TOTAL" >> $GITHUB_OUTPUT

        echo "passed_list<<EOF" >> $GITHUB_OUTPUT
        echo "$PASSED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "failed_list<<EOF" >> $GITHUB_OUTPUT
        echo "$FAILED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Obtener datos del commit
      id: commit_info
      run: |
        echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
        echo "email=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_OUTPUT
        echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
        echo "count=$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT
        echo "time=$(date)" >> $GITHUB_OUTPUT

    - name: Rellenar HTML seguro
      run: |
        TMP_HTML="index_tmp.html"

        STATUS="${{ steps.run_tests.outputs.status }}"
        STATUS_TEXT=$([ "$STATUS" = "success" ] && echo "✅ TODOS LOS TESTS PASARON" || echo "❌ HAY TESTS FALLIDOS")

        PASSED_HTML=$(echo "${{ steps.run_tests.outputs.passed_list }}" | sed 's/.*/<li class="pass">&<\/li>/')
        FAILED_HTML=$(echo "${{ steps.run_tests.outputs.failed_list }}" | sed 's/.*/<li class="fail">&<\/li>/')

        # Escapar caracteres especiales
        AUTHOR_ESC=$(printf '%s\n' "${{ steps.commit_info.outputs.author }}" | sed 's/[&/\]/\\&/g')
        EMAIL_ESC=$(printf '%s\n' "${{ steps.commit_info.outputs.email }}" | sed 's/[&/\]/\\&/g')
        MSG_ESC=$(printf '%s\n' "${{ steps.commit_info.outputs.message }}" | sed 's/[&/\]/\\&/g')
        PASSED_HTML_ESC=$(printf '%s\n' "$PASSED_HTML" | sed 's/[&/\]/\\&/g')
        FAILED_HTML_ESC=$(printf '%s\n' "$FAILED_HTML" | sed 's/[&/\]/\\&/g')

        sed \
          -e "s|{{STATUS_TEXT}}|$STATUS_TEXT|g" \
          -e "s|{{STATUS}}|$STATUS|g" \
          -e "s|{{AUTHOR}}|$AUTHOR_ESC|g" \
          -e "s|{{EMAIL}}|$EMAIL_ESC|g" \
          -e "s|{{COMMIT_MESSAGE}}|$MSG_ESC|g" \
          -e "s|{{COMMIT_COUNT}}|${{ steps.commit_info.outputs.count }}|g" \
          -e "s|{{TIMESTAMP}}|${{ steps.commit_info.outputs.time }}|g" \
          -e "s|{{TESTS_PASSED}}|${{ steps.run_tests.outputs.tests_passed }}|g" \
          -e "s|{{TESTS_FAILED}}|${{ steps.run_tests.outputs.tests_failed }}|g" \
          -e "s|{{TESTS_TOTAL}}|${{ steps.run_tests.outputs.tests_total }}|g" \
          -e "s|{{PASSED_LIST}}|$PASSED_HTML_ESC|g" \
          -e "s|{{FAILED_LIST}}|$FAILED_HTML_ESC|g" \
          index.html > $TMP_HTML

        mv $TMP_HTML index.html

    - name: Subir archivo para Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
